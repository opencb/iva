<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="jso-styles.html">
<link rel="import" href="welcome.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/variant/variant-analysis.html">

<link rel="import" href="../lib/jsorolla/src/lib/opencga/variant/variant-browser.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/variant/variant-prioritization.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/variant/beacon-tool.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/opencga-gene-view.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/opencga-transcript-view.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/opencga-protein-view.html">
<!--<link rel="import" href="../lib/jsorolla/src/lib/cellbase/genome-context.html">-->
<link rel="import" href="../lib/jsorolla/src/lib/opencga/catalog/opencga-projects.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/catalog/opencga-project.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/catalog/opencga-study.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/catalog/opencga-login.html">
<link rel="import" href="../lib/jsorolla/src/lib/opencga/catalog/opencga-upload-file.html">
<link rel="import" href="components/iva-settings.html">

<dom-module id="iva-app">

    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .center {
                margin: auto;
                text-align: justify;
                width: 60%;
                font-size: 18px;
                color: #797979;
            }
            .feature-view {
                margin: auto;
                text-align: justify;
                width: 90%;
            }
            a.studies-menu {
                color: #9d9d9d;
            }
            a.studies-menu:hover {
                color: white;
                text-decoration: none;
                /*cursor: pointer;*/
            }
            .studies-scroll{
                max-height: 300px;
                overflow-y: scroll;
            }
        </style>

        <div>
            <div style="height: 60px;">
                <nav class="navbar navbar-inverse navbar-fixed-top">
                    <div class="container-fluid">

                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a href="#home" class="navbar-brand" style="padding-top: 10px" on-click="changeTool">
                                <img src="{{config.logo}}" width="100px">
                            </a>
                            <a class="navbar-brand" href="#home" on-click="changeTool"><b>{{config.title}} {{config.version}}</b></a>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <!-- Controls aligned to the LEFT -->
                            <ul class="nav navbar-nav">
                                <!-- This code parse the config menu arrays and creates a custom menu taken into account visibility -->
                                <template is="dom-repeat" items="{{config.menu}}" filter="_isMenuItemVisible" as="menuItem">
                                    <!-- If there is not submenu we just display a button -->
                                    <template is="dom-if" if="{{!menuItem.submenu}}">
                                        <li on-click="changeTool"><a href="#{{menuItem.id}}" role="button">{{menuItem.title}}</a></li>
                                    </template>
                                    <!-- If there is a submenu we create a dropdown menu item -->
                                    <template is="dom-if" if="{{menuItem.submenu}}">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{menuItem.title}} <span class="caret"></span></a>
                                            <ul class="dropdown-menu">
                                                <template is="dom-repeat" items="{{menuItem.submenu}}" filter="_isMenuItemVisible" >
                                                    <template is="dom-if" if="{{!item.separator}}">
                                                        <li on-click="changeTool"><a href="#{{item.id}}" data-id="{{item.id}}">{{item.title}}</a></li>
                                                    </template>
                                                    <template is="dom-if" if="{{item.separator}}">
                                                        <li role="separator" class="divider"></li>
                                                    </template>
                                                </template>
                                            </ul>
                                        </li>
                                    </template>
                                </template>
                            </ul>

                            <!-- Controls aligned to the RIGHT: settings and about-->
                            <ul class="nav navbar-nav navbar-right">
                                <!--Projects to show in public mode-->
                                <template is="dom-if" if="{{_publicMode}}">
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                            Studies <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu studies-menu studies-scroll">
                                            <template is="dom-repeat" items="{{projects}}" as="proj">
                                                <li><a><b>{{proj.name}}</b></a></li>
                                                <template is="dom-repeat" items="{{proj.studies}}" as="std">
                                                    <li><a href="#" data-study="{{std.alias}}" data-project="{{proj.name}}" on-click="setProjectStudy">{{std.alias}}</a></li>
                                                </template>
                                                <!--<li role="separator" class="divider"></li>-->
                                            </template>
                                        </ul>
                                    </li>
                                </template>

                                <template is="dom-if" if="{{_logged}}">
                                    <!--User-->
                                    <li><a style="padding: 0px; margin-top: 8px"><i class="fa fa-user fa-2x" aria-hidden="true"></i></a></li>
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                            {{userId}} <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li><a href="#dashboard"><i class="fa fa-line-chart" aria-hidden="true"></i> Dashboard</a></li>
                                            <li><a href="#projects"><i class="fa fa-database" aria-hidden="true"></i> Projects</a></li>
                                            <li><a href="#upload"><i class="fa fa-upload" aria-hidden="true"></i> Upload</a></li>
                                            <li role="separator" class="divider"></li>
                                            <li><a href="#settings"><i class="fa fa-cog" aria-hidden="true"></i> Settings</a></li>
                                        </ul>
                                    </li>

                                    <!--Studies dropdown menu-->
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                            Studies <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu">
                                            <template is="dom-repeat" items="{{projects}}" as="proj">
                                                <li><a><b>{{proj.name}}</b></a></li>
                                                <template is="dom-repeat" items="{{proj.studies}}" as="std">
                                                    <li><a href="#" data-study="{{std.alias}}" data-project="{{proj.name}}" on-click="setProjectStudy">{{std.alias}}</a></li>
                                                </template>
                                                <!--<li role="separator" class="divider"></li>-->
                                            </template>
                                        </ul>
                                    </li>
                                    <li class="divider-vertical"></li>
                                </template>


                                <form class="navbar-form navbar-left" role="search">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="searchTextBox" placeholder="{{config.search.placeholder}}"
                                               on-keyup="buildQuery" style="width: 170px;">
                                        <a style="cursor: pointer">
                                            <span class="fa fa-search" aria-hidden="true" on-click="buildQuery"></span>
                                        </a>
                                    </div>
                                </form>

                                <!-- About dropdown menu-->
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <template is="dom-repeat" items="{{config.about}}">
                                            <li><a href="{{item.url}}" target="_blank"><i class$="{{item.icon}}" aria-hidden="true"></i> {{item.name}}</a></li>
                                        </template>
                                    </ul>
                                </li>

                                <!-- Login/Logout button -->
                                <template is="dom-if" if="{{_isMenuItemVisible(config.login)}}">
                                    <li>
                                        <template is="dom-if" if="{{!_logged}}">
                                            <a href="#login" role="button">
                                                <i class="fa fa-sign-in fa-lg"></i> Login
                                            </a>
                                        </template>
                                        <template is="dom-if" if="{{_logged}}">
                                            <a href="#logout" on-click="logout">
                                                <i class="fa fa-sign-out fa-lg"></i> Logout
                                            </a>
                                        </template>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
            <!-- End of navigation bar -->


            <!--Breadcrumb-->
            <ol hidden$="{{!_isBreadcrumbVisible}}" id="breadcrumb" class="breadcrumb" style="margin-bottom: 1px;padding-left: 40px"></ol>


            <!-- This is where main application is rendered -->
            <div class="center">
                <div class="collapse content" id="home">
                    <welcome-web on-search="buildQuery" project="{{project}}" study="{{study.name}}"></welcome-web>
                </div>
            </div>

            <div>
                <div class="collapse content" id="analysis">
                    <variant-analysis title="Variant Analysis" host="{{opencga.host}}" project="{{project}}" study="{{study}}" samples="{{samples}}"
                                      config="{{config.tools.prioritization}}" population-frequencies="{{populationFrequencies}}" protein-substitution-scores="{{proteinSubstitutionScores}}" consequence-types="{{consequenceTypes}}"
                                      opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"></variant-analysis>
                </div>

                <div class="collapse content" id="samples">
                    <opencga-sample-browser opencga-client="{{opencgaClient}}" study="{{study.id}}" samples="{{samples}}" prefix="{{prefix}}"></opencga-sample-browser>
                </div>
                <div class="collapse content" id="browser">
                    <variant-browser title="Variant Browser" host="{{opencga.host}}" project="{{project}}" study="{{study}}" studies="{{project.studies}}"
                                     config="{{config.tools.browser}}" population-frequencies="{{populationFrequencies}}" protein-substitution-scores="{{proteinSubstitutionScores}}"
                                     consequence-types="{{consequenceTypes}}" opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                     beacon-hosts="{{config.tools.beacon.hosts}}" search="{{_query}}" query="{{_query}}" on-gene="geneSelected">
                    </variant-browser>
                </div>

                <div class="collapse content" id="family-prioritization">
                    <variant-prioritization mode="family" title="Family Prioritization" host="{{opencga.host}}" project="{{project}}" study="{{study}}" samples="{{samples}}"
                                            config="{{config.tools.prioritization}}" population-frequencies="{{populationFrequencies}}" protein-substitution-scores="{{proteinSubstitutionScores}}" consequence-types="{{consequenceTypes}}"
                                            opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}" on-gene="geneSelected">
                    </variant-prioritization>
                </div>

                <div class="collapse content" id="cancer-prioritization">
                    <variant-prioritization mode="cancer" title="Cancer Prioritization" host="{{opencga.host}}" project="{{project}}" study="{{study}}" samples="{{samples}}"
                                            population-frequencies="{{populationFrequencies}}" protein-substitution-scores="{{proteinSubstitutionScores}}" consequence-types="{{consequenceTypes}}"
                                            opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}" on-gene="geneSelected">
                    </variant-prioritization>
                </div>

                <div class="collapse content" id="beacon">
                    <beacon-tool opencga-client="{{opencgaClient}}" studies="{{project.studies}}"></beacon-tool>
                </div>

                <div class="collapse content" id="genomeBrowser">
                    Not implemented yet.
                    <!--<genome-context></genome-context>-->
                </div>

                <div class="collapse content feature-view" id="gene">
                    <opencga-gene-view cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}" project="{{project}}" study="{{study}}"
                                       gene="{{gene}}" population-frequencies="{{populationFrequencies}}" consequence-types="{{consequenceTypes}}"
                                       protein-substitution-scores="{{proteinSubstitutionScores}}" config="{{config.tools.gene}}"></opencga-gene-view>
                </div>

                <div class="collapse content feature-view" id="transcript">
                    <opencga-transcript-view cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}" project="{{project}}" study="{{study}}"
                                             transcript="{{transcript}}" gene="{{gene}}" population-frequencies="{{populationFrequencies}}" consequence-types="{{consequenceTypes}}"
                                             protein-substitution-scores="{{proteinSubstitutionScores}}" config="{{config.tools.gene}}"></opencga-transcript-view>
                </div>

                <div class="collapse content feature-view" id="protein">
                    <opencga-protein-view cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}" project="{{project}}" study="{{study}}"
                                          protein="{{protein}}" population-frequencies="{{populationFrequencies}}" consequence-types="{{consequenceTypes}}"
                                          protein-substitution-scores="{{proteinSubstitutionScores}}" config="{{config.tools.gene.protein}}"></opencga-protein-view>
                </div>

                <div class="collapse content" id="dashboard">
                    Not implemented yet!
                    <!--<opencga-dahsboard></opencga-dahsboard>-->
                </div>

                <div class="collapse content" id="login" style="width: 20%; margin: auto;">
                    <opencga-login on-login="login" opencga-client="{{opencgaClient}}" opencga-client-config="{{opencgaClientConfig}}" login-text="Sign in"></opencga-login>
                </div>

                <div class="collapse content" id="settings" style="width: 40%; margin: auto">
                    <br>
                    <iva-settings opencga-client="{{opencgaClient}}" on-config="refreshConfig" default-config="{{defaultConfig}}"></iva-settings>
                </div>

                <div class="collapse content" id="upload" style="width: 40%; margin-left: 2%">
                    <br>
                    <opencga-upload-file opencga-client="{{opencgaClient}}" study="{{study}}" studies="{{project.studies}}"></opencga-upload-file>
                </div>
                <!--BreadCrumb reference-->
                <div class="collapse content" id="projects" style="width: 60%; margin: auto">
                    <opencga-projects opencga-client="{{opencgaClient}}" projects="{{projects}}" study-summaries="{{studySummaries}}"
                                      on-project="updateProject" on-study="updateStudy"></opencga-projects>
                </div>
                <div class="collapse content" id="project">
                    <opencga-project opencga-client="{{opencgaClient}}" project="{{project}}" study-summaries="{{studySummaries}}"
                                     on-study="updateStudy"></opencga-project>
                </div>
                <div class="collapse content" id="studyInformation">
                    <opencga-study opencga-client="{{opencgaClient}}" project="{{project}}" study="{{study}}"></opencga-study>
                </div>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'iva-app',
            properties: {
                config: {
                    type: Object
                },
                opencgaClient: {
                    type: Object
                },
                cellbaseClient: {
                    type: Object
                },
                userId: {
                    type: String
                },
                projects: {
                    type: Array
                },
                project: {
                    type: Object
                },
                study: {
                    type: Object,
                    observer: 'projectStudySampleChanged'
                },
                samples: {
                    type: Array,
                    observer: 'projectStudySampleChanged'
                },
                studySummaries: {
                    type: Array
                },
                _publicMode: {
                    type: Boolean,
                    value: false
                },
                _logged: {
                    type: Boolean,
                    value: false
                }
            },
            ready: function() {
                // Copy 'application' object from config.js file
                this.config = application;
                this.config.menu.counter = 0;
                this.config.cellbase = cellbase;
                this.config.opencga = opencga;
                this.config.tools = tools;

                this.defaultConfig = {};
                if (typeof populationFrequencies !== "undefined") {
                    this.populationFrequencies = populationFrequencies;
                    // Object.assign() doesn't do deep copy. To keep the default config object unchanged, color is copied into a new object and assigned.
                    let color = Object.assign({}, populationFrequencies.color);
                    this.defaultConfig.populationFrequencies = {color: color};
                }

                if (typeof proteinSubstitutionScores !== "undefined") {
                    this.proteinSubstitutionScores = proteinSubstitutionScores;
                    let sift = Object.assign({}, proteinSubstitutionScores.sift);
                    let polyphen = Object.assign({}, proteinSubstitutionScores.polyphen);
                    this.defaultConfig.proteinSubstitutionScores = {sift: sift, polyphen: polyphen};
                }

                if (typeof consequenceTypes !== "undefined") {
                    this.consequenceTypes = consequenceTypes;
                    let color = Object.assign({}, consequenceTypes.color);
                    this.defaultConfig.consequenceTypes = {color: color};
                }

                // We need to listen to hash fragment changes to update the display and breadcrumb
                var _this = this;
                window.onhashchange = function () {
                    _this.hashFragmentListener(_this);
                };

//                this._checkVersion();

                // Remember the tool that was previously set
                this.tool = window.location.hash.split('/')[0];
                if (this.tool == "") {
                    this.tool = "#home";
                }

                // go to the page that tool has
                $('.content').hide();
                if (window.location.hash != this.tool) {
                    window.location.hash = this.tool;
                } else {
                    $(this.tool).show();
                }

                this.init();

                // This must happen after calling to init() function since init() created the OpencgaClient
                var sid = Cookies.get(this.config.opencga.cookies.sessionId);
                if (typeof sid !== "undefined" && sid != "" && !this._publicMode) {
                    this.login({
                        detail: {
                            userId: Cookies.get(this.config.opencga.cookies.userName),
                            sessionId: sid
                        }
                    });
                }
            },
            attached: function() {
                this.config = Object.assign({}, this.config);

                this.renderBreadcrumb();
            },
            init: function () {
                this.opencgaClientConfig = new OpenCGAClientConfig(this.config.opencga.host, this.config.opencga.version, true, "iva");
                this.opencgaClient = new OpenCGAClient(this.opencgaClientConfig);

                this.cellBaseClientConfig = new CellBaseClientConfig(hosts = this.config.cellbase.hosts, version = this.config.cellbase.version, species = "hsapiens");
                this.cellbaseClient = new CellBaseClient(this.cellBaseClientConfig);

                if (typeof this.config.opencga.projects !== "undefined" && this.config.opencga.projects.length > 0 && this._logged == false) {
                    // This web site is set up for browsing public data
                    this._publicMode = true;
                    this.projects = this.config.opencga.projects;
                    // Setting default project and study
//                    this.project = this.projects[0].alias;
//                    this.study = this.projects[0].studies[0];
//                    this.selectedProject = this.projects[0];
                    this.getProjects();
                } else {
                    this._publicMode = false;
//                    this.projects = [];
                    this.project = {};
//                    this.study = {};
//                    this.samples = [];
                }

                this._checkBreadcrumbVisible();
            },
            login: function(credentials) {
                this.userId = credentials.detail.userId;
                this.sessionId = credentials.detail.sessionId;
                this.opencgaClient._config.sessionId = credentials.detail.sessionId;
                this.set('opencgaClient._config', this.opencgaClient._config); // To reflect the changes in '_config' of opencgaClient observers

                this._logged = true;
                this._publicMode = false;

                this.set('config.menu', application.menu.slice()); // Do not remove: this is for refreshing the menu

                if (this.tool === "#login") {
                    this.tool = "#home";
                }
                this.renderHashFragments();

                this.getProjects();
            },
            logout: function() {
                var _this = this;
                this.opencgaClient.users().logout()
                    .then(function() {
                        _this._logout();
                    })
                    .catch(function () {
                        // we need to remove Cookies son OpenCGAClient has failed
                        Cookies.expire(_this.config.opencga.cookies.sessionId);
                        Cookies.expire(_this.config.opencga.cookies.userName);

                        _this._logout();
                    });
            },
            changeTool: function(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                $('.content').hide(); // hides all content divs
                if (typeof e.target !== "undefined" && typeof e.target.attributes.href !== "undefined") {
                    $(e.target.attributes.href.value).show(); // get the href and use it find which div to show
                    this.tool = e.target.attributes.href.value;
                } else {
                    this.tool = "#home";
                }

                this.renderHashFragments();
            },
            getProjects: function () {
                var _this = this;
                if (this._publicMode) {
                    // Get all projects with study info and call to _setup()
                    this.opencgaClient.users().getProjects('anonymous', {shared: true})
                        .then(function (response) {
                            let _projects = response.response[0].result;
                            _this._setup(_projects);
                            _this._checkBreadcrumbVisible();
                        })
                        .catch(function (response) {
                            console.log("An error when getting projects:")
                            console.log(response)
                        });
                } else {
                    this.opencgaClient.users().getProjects(this.userId)
                        .then(function (response) {
                            let _projects = response.response[0].result;
                            _this._setup(_projects);

                            _this._checkBreadcrumbVisible();
                        })
                        .catch(function (response) {
                            console.log("An error when getting projects:")
                            console.log(response)
                            _this.logout();
                        });
                }
            },
            _setup: function (projects) {
                // We check that at least one project with one study exist, otherwise we do not do anything
                if (typeof projects !== "undefined" && projects.length > 0 && projects[0].studies.length > 0) {
                    this.projects = projects;
                    this.project = projects[0];
                    this.study = projects[0].studies[0];

                    let _this = this;
                    let projectPromises = [];
                    projects.forEach(function(project) {
                        let studyPromises = [];
                        project.studies.forEach(function(study) {
                            studyPromises.push(_this.opencgaClient.studies().summary(project.alias + ":" + study.alias));
                        });
                        projectPromises.push(Promise.all(studyPromises)
                            .then(function(responses) {
                                let studies = [];
                                responses.forEach(function (response) {
                                    let study = response.response[0].result[0];
                                    study.creationDate = moment(study.creationDate, "YYYYMMDDHHmmss").format('D MMM YY');
                                    studies.push(study);
                                });
                                return studies;
                            }));
                    });

                    let _projects = [];
                    Promise.all(projectPromises)
                        .then(function(responses) {
                            for (let i = 0; i < responses.length; i++) {
                                _projects.push({id: _this.projects[i].id, alias: _this.projects[i].alias, name: _this.projects[i].name, studies: responses[i]});
                            }
                            _this.studySummaries = _projects;
                        });
                }

            },
            renderHashFragments: function() {
                console.log("renderHashFragments - DEBUG")

                let hashFrag = this.tool;
                if (typeof this.project != "undefined" && typeof this.project.alias !== "undefined" && this.project.alias != "") {

                    hashFrag += "/" + this.project.alias;
                    if (typeof this.study != "undefined" && typeof this.study.alias !== "undefined" && this.study.alias != "") {
                        hashFrag += "/" + this.study.alias;
                    }
                }

                window.location.hash = hashFrag;
            },
            hashFragmentListener: function(ctx) {
                console.log("hashFragmentListener - DEBUG")
                var arr = window.location.hash.split('/');
                let [hashTool, hashProject, hashStudy, feature] = arr;

                // Stopping the recursive call
                if (hashTool != this.tool || (typeof this.project !== "undefined" && hashProject != this.project.alias) ||
                    (typeof this.study !== "undefined" && hashStudy != this.study.alias)) {
                    if (arr.length > 1) {
                        // Field 'project' is being observed, just in case Polymer triggers
                        // an unnecessary event we can check they are really different
                        if (ctx.project.alias != hashProject) {
                            ctx.project.alias = hashProject;
                        }
                        if (arr.length > 2 && ctx.study != hashStudy) {
                            for (let i = 0; i < ctx.projects.length; i++) {
                                if (ctx.projects[i].name == ctx.project.name || ctx.projects[i].alias == ctx.project.alias) {
                                    for (let j = 0; j < ctx.projects[i].studies.length; j++) {
                                        if (ctx.projects[i].studies[j].name == hashStudy || ctx.projects[i].studies[j].alias == hashStudy) {
                                            ctx.study = ctx.projects[i].studies[j];
                                            break;
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }

                    if (typeof feature !== 'undefined' && feature != "") {
                        if (hashTool == "#protein") {
                            ctx.protein = feature;
                        } else if (feature.startsWith("ENST")) {
                            ctx.transcript = feature;
                        } else {
                            ctx.gene = feature;
                        }
                    }
                    ctx.tool = hashTool;
                }

                $('.content').hide();
                $(hashTool).show();
            },
            refreshConfig: function (e) {
                let colorConfig = e.detail.config;
                let _this = this;
                for (let key in colorConfig) {
                    switch(key) {
                        case "consequenceTypes":
                            let ctColor = colorConfig[key].color;
                            for (let impact in ctColor) {
                                _this.consequenceTypes.color[impact] = ctColor[impact];
                            }
                            let ctModified = Object.assign({}, _this.consequenceTypes);
                            _this.set('consequenceTypes', ctModified);
                            break;
                        case "proteinSubstitutionScores":
                            for (let source in colorConfig[key]) {
                                if (source == "sift") {
                                    let sift = colorConfig[key].sift;
                                    for (let prediction in sift) {
                                        _this.proteinSubstitutionScores.sift[prediction] = sift[prediction];
                                    }
                                } else if (source == "polyphen") {
                                    let polyphen = colorConfig[key].polyphen;
                                    for (let pred in polyphen) {
                                        _this.proteinSubstitutionScores.polyphen[pred] = polyphen[pred];
                                    }
                                }
                            }
                            let pssModified = Object.assign({}, _this.proteinSubstitutionScores);
                            _this.set('proteinSubstitutionScores', pssModified);
                            break;
                        case "populationFrequencies":
                            let pfColor = colorConfig[key].color;
                            for (let i in pfColor) {
                                _this.populationFrequencies.color[i] = pfColor[i];
                            }
                            let pfModified = Object.assign({}, _this.populationFrequencies);
                            _this.set('populationFrequencies', pfModified);
                            break;
                    }
                }
            },
            setProjectStudy: function(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
//                $('.content').hide();
//                $('#studyInformation').show();
//                this.tool = "studyInformation";
                for (let i = 0; i < this.projects.length; i++) {
                    if (this.projects[i].name == e.target.dataProject) {
                        this.project = this.projects[i];
                        for (let j = 0; j < this.projects[i].studies.length; j++) {
                            if (this.projects[i].studies[j].name == e.target.innerHTML || this.projects[i].studies[j].alias == e.target.innerHTML) {
                                this.study = this.projects[i].studies[j];
                            }
                        }
                    }
                }
            },
            updateProject: function(e) {
                for (let i = 0; i < this.projects.length; i++) {
                    if (this.projects[i].name == e.detail.project.name) { // getting the selected project from projects array
                        this.project = this.projects[i];
                    }
                }
                this.tool = "#project";
                this.renderHashFragments();
                this.renderBreadcrumb();
            },
            updateStudy: function(e) {
                if (typeof e.detail.project !== "undefined" && e.detail.project.name != "") {
                    this.project = e.detail.project;
                }
                for (let i = 0; i < this.project.studies.length; i++) {
                    if (this.project.studies[i].name == e.detail.study.name || this.project.studies[i].alias == e.detail.study.alias) {
                        this.study = this.project.studies[i];
                    }
                }

//                TODO: Opencga study will be shown later. For now variant browser is shown when the study changes
//                this.tool = "studyInformation";
                this.tool = "#browser";
                this.renderHashFragments();
                this.renderBreadcrumb();
            },
            projectStudySampleChanged: function() {
                console.log("projectStudySampleChanged - DEBUG")

                this.renderHashFragments();
                this.renderBreadcrumb();
            },
            buildQuery: function(e) {
                let query = {};
                let value = "";
                if (typeof e !== "undefined" && typeof e.detail.value !== "undefined") {
                    value = e.detail.value; // It takes care of the fired event from welcome.html
                } else if (typeof e !== "undefined" && e.keyCode == '13' || typeof e !== "undefined" && e.type == "click") {
                    value = this.$.searchTextBox.value;  // When enter key is pressed or search icon is clicked, it takes the value entered and assign it
                }

                if (value != "") {
                    if (value.startsWith("rs") || value.split(':').length > 2) {
                        query.ids = value;
                    } else if (value.indexOf(':') > -1 && value.indexOf('-') > -1) {
                        query.region = value;
                    } else if (value.startsWith("GO:")) {
                        query["annot-go"] = value;
                    } else if (value.startsWith("HP:")) {
                        query["annot-hpo"] = value;
                    } else if (value.startsWith("ENST")) {
                        this.transcript = value;
                        this.tool = "#transcript";
                    } else {
                        this.gene = value;
                        this.tool = "#gene";
                    }

                    // This query object is built for variant browser. Only when the queries to browser are made, we are setting the tool to browser
                    if (Object.keys(query).length > 0) {
                        this._query = query;
                        this.tool = "#browser";
                    }

                    this.renderHashFragments();
                    this.$.searchTextBox.value = ""; // Empty the value of search text box when search is complete and respective view is loaded
                }
            },
            renderBreadcrumb: function() {
                var breadcrumbElement = Polymer.dom(this.root).querySelector("#breadcrumb");

                if (breadcrumbElement != null && typeof this.config !== "undefined") {

                    // If there is no project in config, breadcrumb is set private so that it is shown only when logged in
                    if (typeof this.config.opencga.projects === "undefined" || this.config.opencga.projects.length == 0) {
                        this.config.breadcrumb.visibility = "private";
                    }

                    // we empty everything
                    Polymer.dom(breadcrumbElement).innerHTML = "";

                    // we add the 'Projects' link
                    let projects = this._createBreadcrumbElement(this.config.breadcrumb.title, false, this.config.breadcrumb.title);
                    Polymer.dom(breadcrumbElement).appendChild(projects);

                    // We first check if one study is selected, for this study must be defined and have at least one key
                    if (typeof this.study === "undefined" || Object.keys(this.study).length == 0) {
                        if (typeof this.project !== "undefined" && this.project != null) {
                            let project = this._createBreadcrumbElement(this.project.alias, true, "project"); // render only project if exists
                            Polymer.dom(breadcrumbElement).appendChild(project);
                        }
                    } else {
                        let project = this._createBreadcrumbElement(this.project.alias, false, "project");
                        Polymer.dom(breadcrumbElement).appendChild(project);

                        if (typeof this.samples !== "undefined" && this.samples.length > 0) {
                            let study = this._createBreadcrumbElement(this.study.alias, false, "study");
                            let sampleNames = [];
                            for (let i in this.samples) {
                                sampleNames.push(this.samples[i].name);
                            }
                            let samples = this._createBreadcrumbElement(sampleNames.join(","), true, "sample");
                            Polymer.dom(breadcrumbElement).appendChild(study);
                            Polymer.dom(breadcrumbElement).appendChild(samples);
                        } else {
                            let study = this._createBreadcrumbElement(this.study.alias, true, "study");
                            Polymer.dom(breadcrumbElement).appendChild(study);
                        }
                    }

                    let _this = this;
                    $(".breadcrumb li a").on('click', function(e) {
                        e.preventDefault();
                        $('.content').hide();
                        switch (e.target.dataset.category) {
                            case _this.config.breadcrumb.title:
                                $('#projects').show();
                                _this.tool = "projects";
                                break;
                            case "project":
                                $('#project').show();
                                _this.tool = "project";
                                break;
                            case "study":
//                                $('#studyInformation').show();
//                                _this.tool = "studyInformation";
                                $('#browser').show();
                                _this.tool = "browser";
                                break;
                        }
                        _this.renderHashFragments();
                    });
                }
            },
            _createBreadcrumbElement(name, active, category) {
                var li = document.createElement("li");
                if (active == true) {
                    li.setAttribute("class", "active");
                    li.textContent = name;
                } else {
                    var a = document.createElement("a");
                    a.setAttribute("href", "#");
                    a.setAttribute("class", "");
                    a.setAttribute("data-category", category);
                    a.textContent = name;
                    li.appendChild(a);
                }
                return li;
            },
            _isMenuItemVisible: function(item) {
                switch(item.visibility) {
                    case 'public':
                        return true;
                    case 'private':
                        return this._logged;
                    case 'none':
                    default:
                        return false;
                }
            },
            _checkBreadcrumbVisible: function() {
                if (typeof this.config !== "undefined") {
                    switch(this.config.breadcrumb.visibility) {
                        case 'public':
                            this._isBreadcrumbVisible = true;
                            break;
                        case 'private':
                            this._isBreadcrumbVisible = this._logged;
                            break;
                        case 'none':
                        default:
                            this._isBreadcrumbVisible = false;
                    }
                }
            },
            _logout: function() {
                this.userId = "";
                this.sessionId = "";
                this.opencgaClient._config.sessionId = "";

                this._logged = false;

                this.set('config.menu', application.menu.slice()); // Do not remove: this is for refreshing the menu

                this.tool = "#home";
                window.location.hash = "home";
                this.init();
            }
//            ,
//            _checkVersion: function() {
//                this.versionNav = "You are currently using ";
//                var nav = navigator.userAgent.toLowerCase();
//                if (/opr\/(\d+\.?)+/.test(nav)) {
//                    var aux = /opr\/((\d+\.?)+)/.exec(nav);
//                    this.versionNav += aux[0].replace("opr", "Opera");
//                } else if (/firefox\/(\d+\.?)+/.test(nav)) {
//                    var aux = /firefox\/((\d+\.?)+)/.exec(nav);
//                    this.versionNav += aux[0];
//                } else if (/msie (\d+\.?)+/.test(nav) || /rv\:(\d+\.?)+/.test(nav)) {
//                    var aux = /msie ((\d+\.?)+)/.exec(nav);
//                    if (aux == null) {
//                        aux = /rv\:((\d+\.?)+)/.exec(nav);
//                        this.versionNav += aux[0].replace("rv:", "Internet Explorer");
//                    } else {
//                        this.versionNav += aux[0].replace("msie", "Internet Explorer");
//                    }
//                } else if (/safari\/(\d+\.?)+/.test(nav) && nav.indexOf("chrome") == -1) {
//                    var aux = /safari\/((\d+\.?)+)/.exec(nav);
//                    this.versionNav += aux[0];
//                } else if (/chrome\/(\d+\.?)+/.test(nav)) {
//                    var aux = /chrome\/((\d+\.?)+)/.exec(nav);
//                    this.versionNav += aux[0];
//                } else {
//                    this.versionNav = "You are currently using an unsupported browser";
//                }
//                if (nav.indexOf("_64") >= 0) {
//                    this.versionNav += " (64-bits)"
//                } else if (nav.indexOf("_32") >= 0) {
//                    this.versionNav += " (32-bits)"
//                }
//            }
        });
    </script>
</dom-module>
