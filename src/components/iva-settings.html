<dom-module id="iva-settings">
    <template>
        <div>
            <button type="button" class="btn btn-default" style="float: right" on-click="resetToDefault">Reset</button>
            <br>

            <h4>CellBase</h4>
            <hr>
            <div class="form-group row">
                <label for="cellbaseHost" class="col-sm-2 col-form-label">Host URL</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="cellbaseHost"
                           value="http://bioinfo.hpc.cam.ac.uk/cellbase">
                </div>
            </div>
            <div class="form-group row">
                <label for="cellbaseVersion" class="col-sm-2 col-form-label">Version</label>
                <div class="col-sm-2">
                    <select name="version" class="form-control" id="cellbaseVersion">
                        <option>v3</option>
                        <option selected>v4</option>
                    </select>
                </div>
            </div>

            <h4>Visual Settings</h4>
            <hr>

            <div class="col-sm-3">
                <label>Consequence Type</label>
            </div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">High</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="CT_high">
                        <input type="text" value="#ff0000" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Moderate</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="CT_moderate">
                        <input type="text" value="#ffa500" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Low</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="CT_low">
                        <input type="text" value="#0000ff" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Modifier</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="CT_modifier">
                        <input type="text" value="#00ff00" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>
            <hr>

            <div class="col-sm-3"><label>Sift</label></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Deleterious</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PSS_sift_deleterious">
                        <input type="text" value="#ff0000" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Tolerated</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PSS_sift_tolerated">
                        <input type="text" value="#00ff00" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>
            <hr>

            <div class="col-sm-3">
                <label>Polyphen</label>
            </div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Probably Damaging</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PSS_polyphen_probablyDamaging">
                        <input type="text" value="#ff0000" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Possibly Damaging</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PSS_polyphen_possiblyDamaging">
                        <input type="text" value="#ffa500" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Benign</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PSS_polyphen_benign">
                        <input type="text" value="#00ff00" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Unknown</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PSS_polyphen_unknown">
                        <input type="text" value="#000000" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>
            <hr>

            <div class="col-sm-3">
                <label>Population Frequencies</label>
            </div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Very Rare</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PF_veryRare">
                        <input type="text" value="#ff0000" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Rare</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PF_rare">
                        <input type="text" value="#ffff00" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Average</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PF_average">
                        <input type="text" value="#ffa500" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3"></div>
            <div class="form-group row">
                <label class="col-sm-2" style="font-weight: normal">Common</label>
                <div class="col-sm-3">
                    <div class="input-group colorpicker-component" id="PF_common">
                        <input type="text" value="#0000ff" class="form-control"/>
                        <span class="input-group-addon"><i></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group row" style="float: right;">
                <button type="button" class="btn btn-primary" on-click="buildConfig">OK</button>
            </div>
        </div>

    </template>
    <script>
        class IvaSettings extends Polymer.Element {
            static get is() {
                return 'iva-settings';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object,
                        value: function () {
                            return {'_config': {}};
                        }
                    },
                    defaultConfig: {
                        type: Object,
                        value: {}
                    }
                }
            }

            static get observers() {
                return ['checkUserConfig(opencgaClient._config.*)'];
            }


            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
            }

            connectedCallback() {
                super.connectedCallback();

                this.config = {};
                this.ctColor = {};
                this.sift = {};
                this.polyphen = {};
                this.pfColor = {};
                let _this = this;
                $('.colorpicker-component').colorpicker();
                $('.colorpicker-component').on('changeColor', function (e) {
                    let fields = e.target.id.split('_');
                    switch (fields[0]) {
                        case "CT":
                            switch (fields[1]) {
                                case "high":
                                    Object.assign(_this.ctColor, {high: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                                case "moderate":
                                    Object.assign(_this.ctColor, {moderate: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                                case "low":
                                    Object.assign(_this.ctColor, {low: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                                case "modifier":
                                    Object.assign(_this.ctColor, {modifier: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                            }
                            break;
                        case "PSS":
                            if (fields[1] == "sift") {
                                switch (fields[2]) {
                                    case "deleterious":
                                        Object.assign(_this.sift, {deleterious: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                        break;
                                    case "tolerated":
                                        Object.assign(_this.sift, {tolerated: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                        break;
                                }
                            }
                            if (fields[1] == "polyphen") {
                                switch (fields[2]) {
                                    case "probablyDamaging":
                                        Object.assign(_this.polyphen, {probablyDamaging: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                        break;
                                    case "possiblyDamaging":
                                        Object.assign(_this.polyphen, {possiblyDamaging: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                        break;
                                    case "benign":
                                        Object.assign(_this.polyphen, {benign: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                        break;
                                    case "unknown":
                                        Object.assign(_this.polyphen, {unknown: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                        break;
                                }
                            }
                            break;
                        case "PF":
                            switch (fields[1]) {
                                case "veryRare":
                                    Object.assign(_this.pfColor, {veryRare: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                                case "rare":
                                    Object.assign(_this.pfColor, {rare: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                                case "average":
                                    Object.assign(_this.pfColor, {average: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                                case "common":
                                    Object.assign(_this.pfColor, {common: PolymerUtils.querySelector("input", PolymerUtils.getElementById(e.target.id)).value});
                                    break;
                            }
                            break;
                    }
                });

            }


            checkUserConfig(config) {
                let _this = this;
                if (this.opencgaClient instanceof OpenCGAClient && UtilsNew.isNotUndefined(config.value.sessionId)) {
                    this.opencgaClient.users().getConfig("iva", {}, {})
                        .then(function (response) {
                            _this.assignValues(_this.defaultConfig); // Set the default config first
                            _this.assignValues(response.response[0].result[0]); // Update the ones returned in the result
                            _this.dispatchEvent(new CustomEvent('config', {
                                detail: {config: response.response[0].result[0]},
                                bubbles: true,
                                composed: true
                            }));
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                }
            }


            assignValues(config) {
                for (let key in config) {
                    switch (key) {
                        case "consequenceTypes":
                            let colorObj = config[key].color;
                            for (let impact in colorObj) {
                                $("#CT_" + impact).colorpicker('setValue', colorObj[impact]);
                            }
                            break;
                        case "proteinSubstitutionScores":
                            let sift = typeof config[key].sift !== "undefined" ? config[key].sift : {};
                            let polyphen = typeof config[key].polyphen !== "undefined" ? config[key].polyphen : {};
                            for (let prediction in sift) {
                                $("#PSS_sift_" + prediction).colorpicker('setValue', sift[prediction]);
                            }
                            for (let prediction in polyphen) {
                                $("#PSS_polyphen_" + prediction).colorpicker('setValue', polyphen[prediction]);
                            }
                            break;
                        case "populationFrequencies":
                            let color = config[key].color;
                            for (let impact in color) {
                                $("#PF_" + impact).colorpicker('setValue', color[impact]);
                            }
                            break;
                    }
                }
            }


            buildConfig(e) {
                if (Object.keys(this.ctColor).length > 0) {
                    this.config["consequenceTypes"] = {color: this.ctColor};
                }
                if (Object.keys(this.sift).length > 0) {
                    if (UtilsNew.isUndefined(this.config["proteinSubstitutionScores"])) {
                        this.config["proteinSubstitutionScores"] = {};
                    }
                    this.config["proteinSubstitutionScores"].sift = this.sift;
                }
                if (Object.keys(this.polyphen).length > 0) {
                    if (UtilsNew.isUndefined(this.config["proteinSubstitutionScores"])) {
                        this.config["proteinSubstitutionScores"] = {};
                    }
                    this.config["proteinSubstitutionScores"].polyphen = this.polyphen;
                }
                if (Object.keys(this.pfColor).length > 0) {
                    this.config["populationFrequencies"] = {color: this.pfColor};
                }
                let _this = this;
                if (Object.keys(this.config).length > 0 && this.opencgaClient instanceof OpenCGAClient) {
                    this.opencgaClient.users().updateConfig("iva", this.config, {})
                        .then(function (response) {
                            _this.dispatchEvent(new CustomEvent('config', {
                                detail: {config: response.response[0].result[0]},
                                bubbles: true,
                                composed: true
                            }));
                        });
                }

            }

            resetToDefault(e) {
                this.assignValues(this.defaultConfig);
                this.opencgaClient.users().updateConfig("iva", this.defaultConfig, {})
                    .then(function (response) {
                        this.dispatchEvent(new CustomEvent('config', {
                            detail: {config: response.response[0].result[0]},
                            bubbles: true,
                            composed: true
                        }));
                    });
            }
        }

        customElements.define(IvaSettings.is, IvaSettings);


    </script>
</dom-module>
